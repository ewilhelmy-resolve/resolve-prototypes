<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authenticated SSE Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .error { background-color: #fff3cd; color: #856404; }
        .messages {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f8f9fa;
        }
        .message {
            margin-bottom: 10px;
            padding: 5px;
            border-left: 3px solid #007bff;
            background-color: white;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .connect { background-color: #28a745; color: white; }
        .disconnect { background-color: #dc3545; color: white; }
        .clear { background-color: #6c757d; color: white; }
        .debug { background-color: #007bff; color: white; }
        .url-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>Authenticated SSE Test - EventSource API</h1>

    <div id="status" class="status disconnected">Disconnected</div>

    <div>
        <label for="sseUrl">SSE URL (with auth token):</label>
        <input type="text" id="sseUrl" class="url-input"
               value="http://localhost:3000/api/sse/events?auth=eyJhbGciOiJIUzI1NiIsImtpZCI6ImF5NCtRbDdPWFIrT3ZvV0MiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL2xtaHlldnVtcW5ya3FyaHl4bWlwLnN1cGFiYXNlLmNvL2F1dGgvdjEiLCJzdWIiOiI1NjVlZTQ2Yi00ZmIyLTQ1ZjItOWZjYS1jMGUxOWI4NzUxNWUiLCJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNzU3OTU2NjgxLCJpYXQiOjE3NTc5NTMwODEsImVtYWlsIjoiYS5hcmF1am8uYXp1YUBnbWFpbC5jb20iLCJwaG9uZSI6IiIsImFwcF9tZXRhZGF0YSI6eyJwcm92aWRlciI6ImVtYWlsIiwicHJvdmlkZXJzIjpbImVtYWlsIl19LCJ1c2VyX21ldGFkYXRhIjp7ImVtYWlsIjoiYS5hcmF1am8uYXp1YUBnbWFpbC5jb20iLCJlbWFpbF92ZXJpZmllZCI6dHJ1ZSwicGhvbmVfdmVyaWZpZWQiOmZhbHNlLCJzdWIiOiI1NjVlZTQ2Yi00ZmIyLTQ1ZjItOWZjYS1jMGUxOWI4NzUxNWUifSwicm9sZSI6ImF1dGhlbnRpY2F0ZWQiLCJhYWwiOiJhYWwxIiwiYW1yIjpbeyJtZXRob2QiOiJwYXNzd29yZCIsInRpbWVzdGFtcCI6MTc1Nzk1MzA4MX1dLCJzZXNzaW9uX2lkIjoiNjM2YjM4MWUtY2RhMS00Y2FlLTg3ZjUtOTcyMzE1NjI4ZTA0IiwiaXNfYW5vbnltb3VzIjpmYWxzZX0.tj5oLULtAiPufroijP_cBKtwC55SrZJQQumz3SAShAw">
    </div>

    <div>
        <button id="connectBtn" class="connect">Connect</button>
        <button id="disconnectBtn" class="disconnect">Disconnect</button>
        <button id="clearBtn" class="clear">Clear Messages</button>
        <button id="debugBtn" class="debug">Debug Info</button>
    </div>

    <h3>Messages:</h3>
    <div id="messages" class="messages"></div>

    <script>
        let eventSource = null;
        const statusEl = document.getElementById('status');
        const messagesEl = document.getElementById('messages');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const clearBtn = document.getElementById('clearBtn');
        const debugBtn = document.getElementById('debugBtn');
        const urlInput = document.getElementById('sseUrl');

        function updateStatus(status, className) {
            statusEl.textContent = status;
            statusEl.className = `status ${className}`;
        }

        function addMessage(message, isError = false) {
            const messageEl = document.createElement('div');
            messageEl.className = 'message';
            if (isError) {
                messageEl.style.borderLeftColor = '#dc3545';
                messageEl.style.backgroundColor = '#f8d7da';
            }
            messageEl.innerHTML = `
                <strong>${new Date().toLocaleTimeString()}</strong><br>
                ${message}
            `;
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function debugInfo() {
            addMessage(`ğŸ” EventSource readyState: ${eventSource ? eventSource.readyState : 'null'}`);
            addMessage(`ğŸ” EventSource url: ${eventSource ? eventSource.url : 'null'}`);
            addMessage(`ğŸ” Browser EventSource support: ${typeof EventSource !== 'undefined'}`);
            addMessage(`ğŸ” Input URL: ${urlInput.value}`);
        }

        function connect() {
            if (eventSource) {
                eventSource.close();
            }

            const url = urlInput.value.trim();
            if (!url) {
                addMessage('âŒ Please provide a URL', true);
                return;
            }

            updateStatus('Connecting...', 'disconnected');
            addMessage(`ğŸš€ Attempting to connect to: ${url}`);

            try {
                eventSource = new EventSource(url);

                eventSource.onopen = function(event) {
                    updateStatus('Connected', 'connected');
                    addMessage('âœ… SSE Connection established');
                    addMessage(`ğŸ” Connection event:`, JSON.stringify({
                        type: event.type,
                        readyState: eventSource.readyState
                    }, null, 2));
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                };

                eventSource.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        addMessage(`ğŸ“¨ Received: ${JSON.stringify(data, null, 2)}`);
                    } catch (e) {
                        addMessage(`ğŸ“¨ Raw message: ${event.data}`);
                    }
                };

                eventSource.onerror = function(event) {
                    updateStatus('Error / Disconnected', 'error');
                    addMessage(`âŒ SSE Error occurred`, true);
                    addMessage(`ğŸ” Error event details: ${JSON.stringify({
                        type: event.type,
                        readyState: eventSource ? eventSource.readyState : 'null',
                        url: eventSource ? eventSource.url : 'null'
                    }, null, 2)}`, true);

                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;

                    if (eventSource && eventSource.readyState === EventSource.CLOSED) {
                        addMessage('ğŸ” Connection was closed by server', true);
                    }
                };

            } catch (error) {
                updateStatus('Error', 'error');
                addMessage(`âŒ Failed to create EventSource: ${error.message}`, true);
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        function disconnect() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                updateStatus('Disconnected', 'disconnected');
                addMessage('ğŸ”Œ Disconnected by user');
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        function clearMessages() {
            messagesEl.innerHTML = '';
        }

        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        clearBtn.addEventListener('click', clearMessages);
        debugBtn.addEventListener('click', debugInfo);

        // Initial state
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;

        addMessage('ğŸ”§ Ready to test authenticated SSE connection.');
        addMessage('ğŸ“ Make sure to update the token in the URL if needed.');
        addMessage('ğŸš€ Click Connect to start testing.');
    </script>
</body>
</html>