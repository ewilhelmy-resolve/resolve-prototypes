# Keycloak Theming with Tailwind CSS: A Design Document

## 1\. Objective

This document outlines the technical approach for creating a modern, responsive, and maintainable custom theme for the Keycloak login page using the **Tailwind CSS** framework. The goal is to establish a robust development workflow that enables rapid UI development while integrating seamlessly with Keycloak's existing theme mechanism.

-----

## 2\. Background & Rationale

Keycloak's default theming system relies on static CSS files. While functional, writing custom CSS from scratch can be time-consuming and difficult to maintain.

**Tailwind CSS** is a utility-first CSS framework that provides low-level utility classes to build custom designs directly in the markup. Adopting this approach offers several advantages:

* **Rapid Development:** Quickly style components without leaving your HTML/template files.
* **Consistency:** Easily maintain a consistent design system (spacing, colors, typography).
* **Performance:** The final CSS bundle is extremely small, as it only includes the styles that are actually used in the project.

This design integrates a modern front-end build process with Keycloak's server environment.

-----

## 3\. Core Architecture

The solution connects a local **Node.js-based build process** with the **Keycloak Docker environment**.

1.  **Keycloak's Role:** The Keycloak instance, running in Docker, is responsible only for serving the final, compiled theme assets. It has no awareness of Tailwind CSS. We use a Docker volume mount to inject our theme files into the container at `/opt/keycloak/themes/`.
2.  **Tailwind's Role:** The Tailwind CSS CLI runs locally on the developer's machine. It is configured to:
    * **Watch** for changes in the theme's Freemarker template files (`.ftl`).
    * **Scan** these files for Tailwind utility classes (e.g., `bg-blue-500`, `flex`, `p-4`).
    * **Generate** a static `styles.css` file containing only the necessary CSS rules.
3.  **Integration:** The generated `styles.css` file is placed in the theme's `resources/css/` directory. Because this directory is mounted into the Docker container, Keycloak can immediately serve the updated stylesheet. Disabling Keycloak's theme cache during development (`--spi-theme-cache-themes=false`) ensures changes are visible upon browser refresh.

-----

## 4\. Implementation Details

### 4.1. Directory Structure

The project will be organized as follows to keep the Keycloak configuration and the theme development setup clean. The `keycloak/` directory is self-contained with its own build tooling and dependencies.

```
.
├── docker-compose.yml       # Docker configuration for Keycloak
├── package.json             # Root project file with convenience scripts
└── keycloak/
    ├── package.json         # Theme-specific dependencies (Tailwind CSS)
    ├── tailwind.config.js   # Tailwind CSS configuration
    ├── realm-export.json
    └── themes/
        └── rita-theme/      # Our custom theme directory
            └── login/
                ├── input.css                  # Tailwind source file
                ├── theme.properties           # Keycloak theme configuration
                ├── login.ftl                  # Customized login template
                ├── login-reset-password.ftl   # Customized password reset template
                └── resources/
                    └── css/
                        └── styles.css # <-- Auto-generated by Tailwind
```

### 4.2. Templates to Customize

This theme will override the following Keycloak templates:

1. **`login.ftl`** - Main login page
   - Username/email input
   - Password input
   - Remember me checkbox
   - Login button
   - Links to registration and password reset

2. **`login-reset-password.ftl`** - Password reset request page
   - Username/email input for password reset
   - Submit button
   - Back to login link

Both templates will be customized with Tailwind CSS utility classes to match the Rita application design system.

### 4.3. Configuration Files

**`docker-compose.yml`**

The Keycloak service will be configured to mount the themes directory and disable caching for development.

```yaml
keycloak:
  image: quay.io/keycloak/keycloak:24.0.4
  # ... (environment variables)
  ports:
    - "8080:8080"
  volumes:
    - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json
    - ./keycloak/themes:/opt/keycloak/themes/
  command: >
    start-dev 
    --import-realm 
    --spi-theme-cache-themes=false 
    --spi-theme-cache-templates=false
```

**`keycloak/tailwind.config.js`**

This file configures Tailwind to scan the correct template files for utility classes. Note the relative paths from the `keycloak/` directory.

```javascript
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    './themes/rita-theme/login/**/*.ftl',
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}
```

**`keycloak/package.json`**

This file defines the theme-specific dependencies and build scripts. The Keycloak theme has its own isolated `node_modules` directory.

```json
{
  "name": "keycloak-rita-theme",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "tailwindcss -i ./themes/rita-theme/login/input.css -o ./themes/rita-theme/login/resources/css/styles.css --watch",
    "build": "tailwindcss -i ./themes/rita-theme/login/input.css -o ./themes/rita-theme/login/resources/css/styles.css --minify"
  },
  "devDependencies": {
    "tailwindcss": "^3.4.3"
  }
}
```

**Root `package.json` (convenience scripts)**

Add these convenience scripts to the root `package.json` to run theme commands from the project root.

```json
{
  "scripts": {
    "dev:theme": "cd keycloak && npm run dev",
    "build:theme": "cd keycloak && npm run build"
  }
}
```

**`theme.properties`**

This file, located at `keycloak/themes/rita-theme/login/theme.properties`, configures Keycloak to use our generated stylesheet.

```properties
parent=keycloak
styles=css/styles.css
```

-----

## 5\. Development Workflow

A developer will follow these steps to work on the theme:

1.  **Install Dependencies:** First time only, install theme dependencies.
    ```bash
    cd keycloak && npm install
    ```
2.  **Start Services:** Open two separate terminal windows.
    * **Terminal 1:** Run `docker compose up` to start the Keycloak container.
    * **Terminal 2:** Run `npm run dev:theme` (from project root) or `cd keycloak && npm run dev` to start the Tailwind CSS watcher.
3.  **Modify Templates:** To customize a page, copy the original template (e.g., `login.ftl`) from the base theme into the `keycloak/themes/rita-theme/login/` directory.
4.  **Apply Styles:** Edit the `.ftl` template and add Tailwind utility classes directly to the HTML elements.
5.  **Auto-Compilation:** Upon saving the file, the Tailwind watcher will automatically regenerate the `styles.css` file.
6.  **View Changes:** Refresh the login page in the browser to see the new styles applied.

-----

## 6\. Packaging and Handoff for Production

For production environments, the theme should be packaged into a single, versionable Java Archive (`.jar`) file. This artifact is the deliverable for the DevOps team, as it simplifies deployment and fits neatly into CI/CD pipelines.

### 6.1. Why a JAR Archive?

* **Atomic Deployment:** The entire theme is deployed or removed as a single file.
* **Versioning:** The JAR can be versioned (e.g., `rita-theme-v1.2.0.jar`) and stored in an artifact repository like Nexus or Artifactory.
* **Cleanliness:** It keeps the Keycloak `providers/` directory organized, as opposed to manually copying loose files into the `themes/` directory.

### 6.2. Packaging Steps

The process involves creating a specific directory structure and then using a standard `jar` command to create the archive.

**Step 1: Build the Final CSS**

First, ensure you have the final, minified CSS file by running the production build script from your project root.

```bash
npm run build:theme
```

Or from the keycloak directory:

```bash
cd keycloak && npm run build
```

**Step 2: Prepare the Packaging Directory**

Create a temporary directory (e.g., `build_temp`) to stage the files exactly as they need to appear inside the JAR.

```
build_temp/
├── META-INF/
│   └── keycloak-themes.json
└── theme/
    └── rita-theme/
        └── login/
            ├── theme.properties
            └── resources/
                └── css/
                    └── styles.css  # <-- The minified version
```

**Step 3: Create the `keycloak-themes.json` Descriptor**

This JSON file tells Keycloak what themes are inside the JAR. Create the file `build_temp/META-INF/keycloak-themes.json` with the following content:

```json
{
    "themes": [{
        "name" : "rita-theme",
        "types": [ "login" ]
    }]
}
```

**Step 4: Create the JAR File**

Navigate into the `build_temp` directory and run the `jar` command (part of the JDK) to create the archive.

```bash
# Navigate into the staging directory
cd build_temp

# Create the JAR file. The dot '.' at the end is important!
jar -cf ../rita-theme.jar .

# Navigate back out
cd ..
```

This command creates `rita-theme.jar` in your project's root directory.

### 6.3. Handoff to DevOps

The final deliverable is the single **`rita-theme.jar`** file.

**Instructions for the DevOps Team:**

1.  Place the `rita-theme.jar` file into the Keycloak server's **`/opt/keycloak/providers/`** directory.
2.  Restart or redeploy the Keycloak instance.

Upon startup, Keycloak will automatically detect the theme provider JAR and make "rita-theme" available in the Admin Console.

-----

## 7\. Continuous Integration & Deployment

### 7.1. GitHub Actions Workflow

The theme should be automatically built and packaged in CI/CD pipelines. A dedicated GitHub Actions workflow handles theme builds separately from the main application.

**Workflow File:** `.github/workflows/build-keycloak-theme.yml`

```yaml
name: Build Keycloak Theme

on:
  push:
    branches: [main, develop]
    paths:
      - 'keycloak/**'
      - '.github/workflows/build-keycloak-theme.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'keycloak/**'
  workflow_dispatch:
    inputs:
      version:
        description: 'Theme version (e.g., 1.0.0)'
        required: false
        default: 'latest'

jobs:
  build-theme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: keycloak/package-lock.json

      - name: Install dependencies
        working-directory: keycloak
        run: npm ci

      - name: Build theme CSS
        working-directory: keycloak
        run: npm run build

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Package theme as JAR
        working-directory: keycloak
        run: |
          # Create packaging directory
          mkdir -p build_temp/META-INF
          mkdir -p build_temp/theme/rita-theme/login/resources/css

          # Copy theme files
          cp themes/rita-theme/login/theme.properties build_temp/theme/rita-theme/login/
          cp themes/rita-theme/login/*.ftl build_temp/theme/rita-theme/login/
          cp themes/rita-theme/login/resources/css/styles.css build_temp/theme/rita-theme/login/resources/css/

          # Create keycloak-themes.json descriptor
          cat > build_temp/META-INF/keycloak-themes.json <<EOF
          {
              "themes": [{
                  "name" : "rita-theme",
                  "types": [ "login" ]
              }]
          }
          EOF

          # Create JAR
          cd build_temp
          jar -cf ../rita-theme.jar .
          cd ..

      - name: Generate artifact metadata
        id: metadata
        run: |
          VERSION="${{ github.event.inputs.version || 'latest' }}"
          if [ "$VERSION" = "latest" ]; then
            VERSION="$(date +%Y%m%d)-${GITHUB_SHA::8}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "artifact_name=rita-theme-${VERSION}.jar" >> $GITHUB_OUTPUT

      - name: Rename JAR with version
        working-directory: keycloak
        run: |
          mv rita-theme.jar ${{ steps.metadata.outputs.artifact_name }}

      - name: Upload theme artifact
        uses: actions/upload-artifact@v4
        with:
          name: keycloak-theme-${{ steps.metadata.outputs.version }}
          path: keycloak/${{ steps.metadata.outputs.artifact_name }}
          retention-days: 90

      - name: Upload to releases (on tag push)
        if: startsWith(github.ref, 'refs/tags/theme-v')
        uses: softprops/action-gh-release@v1
        with:
          files: keycloak/${{ steps.metadata.outputs.artifact_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

### 7.2. Workflow Triggers

The workflow is triggered by:

1. **Push to main/develop** - Automatically builds theme when keycloak/ files change
2. **Pull Requests** - Validates theme builds successfully before merge
3. **Manual Trigger** - Allows on-demand builds with custom version numbers
4. **Tag Push** - Creates GitHub release with JAR artifact (e.g., `theme-v1.0.0`)

### 7.3. Artifact Storage

**During Development/CI:**
- GitHub Actions artifacts stored for 90 days
- Artifacts named with version: `keycloak-theme-20250121-abc1234`
- Accessible via GitHub Actions UI

**For Production Releases:**
- Use Git tags: `git tag theme-v1.0.0 && git push origin theme-v1.0.0`
- JAR automatically attached to GitHub Release
- DevOps downloads from Releases page
- Alternative: Push to artifact repository (Nexus, Artifactory, S3)

### 7.4. Version Management

**Automatic Versioning (CI builds):**
```
rita-theme-20250121-abc1234.jar
Format: rita-theme-YYYYMMDD-{git-sha}.jar
```

**Manual Versioning (releases):**
```bash
# Create tagged release
git tag theme-v1.2.0
git push origin theme-v1.2.0

# Workflow creates: rita-theme-1.2.0.jar
```

### 7.5. GitIgnore Configuration

Ensure build artifacts are not committed to the repository:

```gitignore
# Keycloak theme build artifacts
keycloak/node_modules/
keycloak/build_temp/
keycloak/*.jar
keycloak/themes/rita-theme/login/resources/css/styles.css
```

The generated `styles.css` should not be committed since it's built from `input.css` during CI/CD.